<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1, shrink-to-fit=no'>

  <title>GDP using D3 v.1</title>

  <link href="https://fonts.googleapis.com/css?family=Material+Icons|Raleway" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vuetify/1.0.8/vuetify.min.css">

  <style>
    /* Hide side scrollbar if content does not need it */
    html {
      overflow-y: auto; 
    }
    
    .application {
      font-family: 'Raleway', sans-serif;
      line-height: 2rem;
      text-align: center;
    }
  </style>
</head>

<body>
  <!-- https://codepen.io/ivanlim/full/ -->
  <!-- Vuetify Material color palette: https://vuetifyjs.com/en/style/colors -->
  <v-app id="app">
    <v-container mt-5 fluid>
      <v-layout wrap justify-center>
        <v-flex xs12 class="mb-5">
          <h1 v-text="appName"></h2>
        </v-flex>

        <v-flex xs12 class="mb-5">
          <div id="d3-chart"></div>
        </v-flex>

      </v-layout>
    </v-container>
  </v-app>

  <script src='https://unpkg.com/vue'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vuetify/1.0.8/vuetify.min.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script type='text/javascript'>
    const CANVAS_MARGIN = {
      top: 20,
      right: 20,
      bottom: 20,
      left: 50
    };
    const CHART_WIDTH = 1000 - CANVAS_MARGIN.right - CANVAS_MARGIN.left;
    const CHART_HEIGHT = 600 - CANVAS_MARGIN.top - CANVAS_MARGIN.bottom;
    const CHART_COLOR = '#fcfcfc';
    const BAR_COLOR = '#9c9';
    const BAR_WIDTH = 20;
    const BAR_OFFSET = 5;

    let v = new Vue({
      el: '#app',
      data () {
        return {
          appName: 'US Gross Domestic Product',
          d3DataX: [],
          d3DataY: [],
          d3Svg: false,
          d3Chart: false
        }
      },
      methods: {
        createChart () {
          let yScale = d3.scaleLinear()
                         .domain([0, d3.max(this.d3DataY)])
                         .range([0, CHART_HEIGHT]);
          let yAxisValues = d3.scaleLinear()
                              .domain([0, d3.max(this.d3DataY)])
                              .range([CHART_HEIGHT, 0]);
          // How many ticks are on the y axis
          let yAxisTicks = d3.axisLeft(yAxisValues)
                             .ticks(10);
          let xAxisValues = d3.scaleLinear()
                              .domain([d3.min(this.d3DataX), d3.max(this.d3DataX)])
                              .range([0, CHART_WIDTH]);
          // How far apart are the ticks on x axis, e.g. 7 days apart
          let xAxisTicks = d3.axisBottom(xAxisValues)
                             .ticks(10);
          // Setting first, last and gap between bars
          let xScale = d3.scaleBand()
                         .domain(this.d3DataY)
                         .paddingInner(0)
                         .paddingOuter(0)
                         .range([0, CHART_WIDTH]);
          
          // Step #1: Select div to place d3 chart, set dimensions and color
          d3.select("#d3-chart")
            .append('svg')
              .attr('width', CHART_WIDTH + CANVAS_MARGIN.right + CANVAS_MARGIN.left)
              .attr('height', CHART_HEIGHT + CANVAS_MARGIN.top + CANVAS_MARGIN.bottom)
              .style('background', CHART_COLOR);
          this.d3Svg = d3.select('#d3-chart svg');
          
          this.d3Chart = this.d3Svg.append('g')
                          .attr('transform', `translate(${CANVAS_MARGIN.left}, -${CANVAS_MARGIN.bottom})`)
                          .selectAll('rect')
                          .data(this.d3DataY)
                          .enter()
                          .append('rect');
          let yGuide = this.d3Svg.append('g')
                          .attr('transform', `translate(${CANVAS_MARGIN.left}, -${CANVAS_MARGIN.bottom})`)
                          .call(yAxisTicks);
          let xGuide = this.d3Svg.append('g')
                          .attr('transform', `translate(${CANVAS_MARGIN.left}, ${-CANVAS_MARGIN.bottom + CHART_HEIGHT})`)
                          .call(xAxisTicks);
          
          this.d3Chart
            .attr('fill', (data, index) => {
              return BAR_COLOR
            })
            .attr('width', data => xScale.bandwidth())
            .attr('x', (data, index) => {
              return xScale(data)
            })
            .attr('y', CHART_HEIGHT + CANVAS_MARGIN.top);
          
          this.d3Chart
            .transition()
            .delay((data, index) => index * 20)
            .duration(10)
            .ease(d3.easeCircle)
            .attr('y', data => {
              return CHART_HEIGHT - yScale(data) + CANVAS_MARGIN.top;
            })
            .attr('height', data => {
              return yScale(data)
            });
        }
      },
      mounted () {
        let url = 'https://raw.githubusercontent.com/FreeCodeCamp/ProjectReferenceData/master/GDP-data.json';
        fetch(url)
          .then(response => response.json())
          .then(json => {
            json.data.forEach(([date, value]) => {
              this.d3DataX.push(+date.substr(0, 4));
              this.d3DataY.push(value);
            });
            console.log('toremove', this.d3DataX)
            this.createChart();
          })
          .catch(error => {
            console.error("Error encountered", error);
          });
      }
    });
  </script>
</body>